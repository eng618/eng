name: Publish to Homebrew

on:
  release:
    types: [published]
  workflow_run:
    workflows: ["Release Please"]
    types: [completed]

concurrency:
  group: publish-homebrew-${{ github.event.release.tag_name || github.run_id }}
  cancel-in-progress: false

permissions:
  contents: write
  actions: read

jobs:
  build:
    if: ${{ (github.event_name == 'release' && github.event.action == 'published') || (github.event_name == 'workflow_run' && github.event.workflow_run.name == 'Release Please' && github.event.workflow_run.conclusion == 'success') }}
    runs-on: ubuntu-latest
    outputs:
      found: ${{ steps.get_tag.outputs.found }}
      tag_name: ${{ steps.get_tag.outputs.tag_name }}
      version_no_v: ${{ steps.get_tag.outputs.version_no_v }}
      checksums: ${{ steps.get_checksums.outputs.checksums }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Determine release tag and version
        id: get_tag
        run: |
          if [ "${{ github.event_name }}" = "release" ]; then
            TAG_NAME="${{ github.event.release.tag_name }}"
            echo "found=true" >> $GITHUB_OUTPUT
          else
            RUN_START="${{ github.event.workflow_run.created_at }}"
            echo "Searching for releases published at or after $RUN_START"
            TAG_NAME=$(curl -s -H "Accept: application/vnd.github+json" -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" "https://api.github.com/repos/${{ github.repository }}/releases" | jq -r --arg RUN_START "$RUN_START" 'map(select(.draft==false and .prerelease==false and (.published_at >= $RUN_START)))[0].tag_name')
            if [ "$TAG_NAME" = "null" ] || [ -z "$TAG_NAME" ]; then
              echo "found=false" >> $GITHUB_OUTPUT
              echo "tag_name=" >> $GITHUB_OUTPUT
              echo "version_no_v=" >> $GITHUB_OUTPUT
              exit 0
            else
              echo "found=true" >> $GITHUB_OUTPUT
            fi
          fi
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
          VERSION_NO_V="${TAG_NAME#v}"
          echo "version_no_v=$VERSION_NO_V" >> $GITHUB_OUTPUT

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: stable

      - name: Cache Go modules
        uses: actions/cache@v4
        with:
          path: ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Run tests
        if: ${{ steps.get_tag.outputs.found == 'true' }}
        run: go test ./...

      - name: Install & Run GoReleaser
        if: ${{ steps.get_tag.outputs.found == 'true' }}
        id: goreleaser
        uses: goreleaser/goreleaser-action@v6
        with:
          distribution: goreleaser
          version: "~> v2"
          args: release --clean --release=false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Persist dist directory
        if: ${{ steps.get_tag.outputs.found == 'true' }}
        uses: actions/upload-artifact@v6
        with:
          name: dist
          path: dist

      - name: Get Checksums
        id: get_checksums
        if: ${{ steps.get_tag.outputs.found == 'true' }}
        run: |
          mkdir -p dist
          # Ensure artifacts.json exists (generated by goreleaser)
          if [ ! -f dist/artifacts.json ]; then
            echo "No artifacts.json found in dist; skipping checksums"
            echo "checksums={}" >> $GITHUB_OUTPUT
            exit 0
          fi
          cd dist
          echo "checksums<<EOF" >> $GITHUB_OUTPUT
          jq -r 'reduce ( .[] | select(.type == "Archive") | select(.name | test("Darwin|Linux")) | {(.name): (.extra.Checksum | split(":")[1])} ) as $item ({}; . + $item)' artifacts.json >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          cd ..

  publish:
    if: ${{ needs.build.outputs.found == 'true' }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Download dist directory
        uses: actions/download-artifact@v7
        with:
          name: dist
          path: dist

      - name: Publish to Homebrew
        env:
          PROJECT_NAME: "eng"
          TAG_NAME: ${{ needs.build.outputs.tag_name }}
          VERSION: ${{ needs.build.outputs.version_no_v }}
          DARWIN_AMD64_FILE: eng_${{ needs.build.outputs.version_no_v }}_Darwin_x86_64.tar.gz
          DARWIN_ARM64_FILE: eng_${{ needs.build.outputs.version_no_v }}_Darwin_arm64.tar.gz
          LINUX_AMD64_FILE: eng_${{ needs.build.outputs.version_no_v }}_Linux_x86_64.tar.gz
          LINUX_ARM64_FILE: eng_${{ needs.build.outputs.version_no_v }}_Linux_arm64.tar.gz
          CHECKSUMS_JSON: ${{ needs.build.outputs.checksums }}
          PAT_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          ./tools/update_homebrew_formula.sh
