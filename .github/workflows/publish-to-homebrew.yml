name: Publish to Homebrew

on:
  release:
    types: [published]
  workflow_run:
    workflows: ["Release Please"]
    types: [completed]

concurrency:
  group: publish-homebrew-${{ github.event.release.tag_name || github.run_id }}
  cancel-in-progress: false

permissions:
  contents: write
  actions: read

jobs:
  build:
    if: ${{ (github.event_name == 'release' && github.event.action == 'published') || (github.event_name == 'workflow_run' && github.event.workflow_run.name == 'Release Please' && github.event.workflow_run.conclusion == 'success') }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: stable

      - name: Cache Go modules
        uses: actions/cache@v4
        with:
          path: ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Run tests
        run: go test ./...

      - name: Install & Run GoReleaser
        id: goreleaser
        uses: goreleaser/goreleaser-action@v6
        with:
          distribution: goreleaser
          version: "~> v2"
          args: release --clean --release=false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Persist dist directory
        uses: actions/upload-artifact@v6
        with:
          name: dist
          path: dist

  publish:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Download dist directory
        uses: actions/download-artifact@v7
        with:
          name: dist
          path: dist

      - name: Determine release tag and version
        id: get_tag
        run: |
          if [ "${{ github.event_name }}" = "release" ]; then
            TAG_NAME="${{ github.event.release.tag_name }}"
          else
            echo "Fetching latest published release tag from GitHub API..."
            TAG_NAME=$(curl -s -H "Accept: application/vnd.github+json" -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" "https://api.github.com/repos/${{ github.repository }}/releases" | jq -r 'map(select(.draft==false and .prerelease==false))[0].tag_name')
          fi
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
          VERSION_NO_V="${TAG_NAME#v}"
          echo "version_no_v=$VERSION_NO_V" >> $GITHUB_OUTPUT

      - name: Get Checksums
        id: get_checksums
        run: |
          cd dist
          echo "checksums<<EOF" >> $GITHUB_OUTPUT
          # Extract checksums using the actual filenames from artifacts.json
          # Keys will be like 'eng_0.17.4_Darwin_x86_64.tar.gz'
          jq -r 'reduce ( .[] | select(.type == "Archive") | select(.name | test("Darwin|Linux")) | {(.name): (.extra.Checksum | split(":")[1])} ) as $item ({}; . + $item)' artifacts.json >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          cd ..



      - name: Publish to Homebrew
        env:
          PROJECT_NAME: "eng"
          TAG_NAME: ${{ steps.get_tag.outputs.tag_name }}
          VERSION: ${{ steps.get_tag.outputs.version_no_v }}
          DARWIN_AMD64_FILE: eng_${{ steps.get_tag.outputs.version_no_v }}_Darwin_x86_64.tar.gz
          DARWIN_ARM64_FILE: eng_${{ steps.get_tag.outputs.version_no_v }}_Darwin_arm64.tar.gz
          LINUX_AMD64_FILE: eng_${{ steps.get_tag.outputs.version_no_v }}_Linux_x86_64.tar.gz
          LINUX_ARM64_FILE: eng_${{ steps.get_tag.outputs.version_no_v }}_Linux_arm64.tar.gz
          CHECKSUMS_JSON: ${{ steps.get_checksums.outputs.checksums }}
          PAT_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          ./tools/update_homebrew_formula.sh
